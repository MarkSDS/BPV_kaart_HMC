<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BPV Kaart HMC</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body { padding: 0; margin: 0; font-family: sans-serif; }
        html, body, #map { height: 100%; width: 100vw; }
        
        /* Popup styling */
        .popup-content { min-width: 230px; }
        .popup-header { font-size: 15px; font-weight: bold; margin-bottom: 2px; color: #333; }
        .popup-cap { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 8px; display: block; }
        .popup-level { display: inline-block; padding: 2px 6px; border-radius: 4px; color: white; font-size: 11px; margin-bottom: 8px; font-weight: bold; margin-right: 3px; text-shadow: 0px 0px 2px rgba(0,0,0,0.5); }
        .popup-content p { margin: 0 0 10px 0; font-size: 13px; color: #666; line-height: 1.4; }
        
        /* Knoppen styling */
        .btn-action {
            display: inline-block; margin-top: 5px; margin-right: 5px; padding: 6px 10px;
            background-color: #4285F4; color: white; text-decoration: none;
            border-radius: 4px; font-size: 12px; font-weight: bold;
        }
        .btn-streetview { background-color: #FFC107; color: #333; }
        .website-link { display: block; margin-top: 10px; color: #0078A8; font-size: 12px; text-decoration: none; }
        .website-link:hover { text-decoration: underline; }

        /* Route input styling */
        .route-box { margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee; background: #f9f9f9; padding: 8px; border-radius: 4px; }
        .route-input { 
            width: 120px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;
        }
        .btn-go {
            background-color: #4caf50; color: white; border: none; padding: 5px 10px;
            border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 12px;
        }

        /* Legenda */
        .legend {
            background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-size: 11px; line-height: 16px; color: #555;
            max-height: 300px; overflow-y: auto;
        }
        .legend h4 { margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
        .legend i { width: 10px; height: 10px; float: left; margin-right: 8px; opacity: 0.8; border-radius: 50%; margin-top: 3px; }
        .legend-section { margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // --- DATA LINK (GID 1928204680) ---
        const googleSheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqbtXG3aiyEMFV--hYMBFojn3Qx2h5fP-aY3cjlMANjGTo1PVhnzR_e_1WTz7Saj2JJFxrtu2hvRx_/pub?gid=1928204680&single=true&output=csv";

        // --- KAART SETUP ---
        var osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' });
        var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] });
        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] });

        // HIER GING HET MIS: De map moet eerst 'schoon' worden aangemaakt
        var map = L.map('map', {
            center: [52.1326, 5.2913],
            zoom: 8,
            layers: [googleStreets] 
        });

        // EN HIER VOEGEN WE DE ZOEKBALK PAS TOE (NA DE AANMAAK)
        L.Control.geocoder({
            defaultMarkGeocode: false 
        })
        .on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ]);
            map.fitBounds(poly.getBounds());
        })
        .addTo(map);

        // --- CLUSTERS MAKEN (6 BAKJES) ---
        // Hout & Meubel
        var cl_HM_N2 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_HM_N3 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_HM_N4 = L.markerClusterGroup({ maxClusterRadius: 40 });
        
        // Interieur & Advies
        var cl_IA_N2 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_IA_N3 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_IA_N4 = L.markerClusterGroup({ maxClusterRadius: 40 });

        // Standaard alles aanzetten
        map.addLayer(cl_HM_N2); map.addLayer(cl_HM_N3); map.addLayer(cl_HM_N4);
        map.addLayer(cl_IA_N2); map.addLayer(cl_IA_N3); map.addLayer(cl_IA_N4);

        // --- LAYER CONTROL (MENU) ---
        var baseMaps = { "Kaart":
