<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BPV Kaart HMC</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body { padding: 0; margin: 0; font-family: sans-serif; }
        html, body, #map { height: 100%; width: 100vw; }
        
        /* Popup styling */
        .popup-content { min-width: 230px; }
        .popup-header { font-size: 15px; font-weight: bold; margin-bottom: 2px; color: #333; }
        .popup-cap { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 8px; display: block; }
        .popup-level { display: inline-block; padding: 2px 6px; border-radius: 4px; color: white; font-size: 11px; margin-bottom: 8px; font-weight: bold; margin-right: 3px; text-shadow: 0px 0px 2px rgba(0,0,0,0.5); }
        .popup-content p { margin: 0 0 10px 0; font-size: 13px; color: #666; line-height: 1.4; }
        
        /* Knoppen styling */
        .btn-action {
            display: inline-block; margin-top: 5px; margin-right: 5px; padding: 6px 10px;
            background-color: #4285F4; color: white; text-decoration: none;
            border-radius: 4px; font-size: 12px; font-weight: bold;
        }
        .btn-streetview { background-color: #FFC107; color: #333; }
        .website-link { display: block; margin-top: 10px; color: #0078A8; font-size: 12px; text-decoration: none; }
        .website-link:hover { text-decoration: underline; }

        /* Route input styling */
        .route-box { margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee; background: #f9f9f9; padding: 8px; border-radius: 4px; }
        .route-input { 
            width: 120px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;
        }
        .btn-go {
            background-color: #4caf50; color: white; border: none; padding: 5px 10px;
            border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 12px;
        }

        /* Legenda Linksonder */
        .legend {
            background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-size: 11px; line-height: 16px; color: #555;
            max-height: 300px; overflow-y: auto;
        }
        .legend h4 { margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
        .legend i { width: 10px; height: 10px; float: left; margin-right: 8px; opacity: 0.8; border-radius: 50%; margin-top: 3px; }

        /* --- MENU STYLING (Rechtsboven) --- */
        .leaflet-control-layers-expanded {
            min-width: 200px !important;
            padding: 10px !important;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4) !important;
        }
        
        /* De tussenkopjes in het menu */
        .menu-header {
            margin-top: 12px;
            margin-bottom: 4px;
            font-weight: bold;
            color: #333;
            text-transform: uppercase;
            font-size: 11px;
            border-bottom: 2px solid #eee;
            padding-bottom: 2px;
        }
        
        /* Eerste kopje heeft geen witruimte boven nodig */
        .menu-header:first-of-type { margin-top: 0; }
        
        /* Ruimte tussen de checkboxes */
        .leaflet-control-layers label { margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // --- DATA LINK (GID 1928204680) ---
        const googleSheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqbtXG3aiyEMFV--hYMBFojn3Qx2h5fP-aY3cjlMANjGTo1PVhnzR_e_1WTz7Saj2JJFxrtu2hvRx_/pub?gid=1928204680&single=true&output=csv";

        // --- KAART SETUP ---
        var osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' });
        var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] });
        var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] });

        // Kaart aanmaken
        var map = L.map('map', {
            center: [52.1326, 5.2913],
            zoom: 8,
            layers: [googleStreets] 
        });

        // Zoekbalk toevoegen
        L.Control.geocoder({
            defaultMarkGeocode: false 
        })
        .on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
                bbox.getSouthEast(), bbox.getNorthEast(),
                bbox.getNorthWest(), bbox.getSouthWest()
            ]);
            map.fitBounds(poly.getBounds());
        })
        .addTo(map);

        // --- CLUSTERS MAKEN (6 BAKJES) ---
        // Hout & Meubel
        var cl_HM_N2 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_HM_N3 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_HM_N4 = L.markerClusterGroup({ maxClusterRadius: 40 });
        
        // Interieur & Advies
        var cl_IA_N2 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_IA_N3 = L.markerClusterGroup({ maxClusterRadius: 40 });
        var cl_IA_N4 = L.markerClusterGroup({ maxClusterRadius: 40 });

        // Standaard alles aanzetten
        map.addLayer(cl_HM_N2); //map.addLayer(cl_HM_N3); map.addLayer(cl_HM_N4);
        //map.addLayer(cl_IA_N2); map.addLayer(cl_IA_N3); map.addLayer(cl_IA_N4);

        // --- LAYER CONTROL (MENU) ---
        var baseMaps = { "Kaart": googleStreets, "Satelliet": googleSat };
        
        // We gebruiken hier simpele namen. Het scriptje onderaan voegt de headers toe.
        var flatOverlayMaps = {
            "<span style='color:#4caf50'>‚óè</span> HM Niveau 2": cl_HM_N2,
            "<span style='color:#ff9800'>‚óè</span> HM Niveau 3": cl_HM_N3,
            "<span style='color:#9c27b0'>‚óè</span> HM Niveau 4": cl_HM_N4,
            
            "<span style='color:#00bcd4'>‚óè</span> IA Niveau 2": cl_IA_N2,
            "<span style='color:#fdd835'>‚óè</span> IA Niveau 3": cl_IA_N3,
            "<span style='color:#e91e63'>‚óè</span> IA Niveau 4": cl_IA_N4
        };

        L.control.layers(baseMaps, flatOverlayMaps, {collapsed: true}).addTo(map);

        // --- LEGENDA (Linksonder) ---
        var legend = L.control({position: 'bottomleft'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += "<h4>Hout & Meubel</h4>";
            div.innerHTML += '<i style="background: #9c27b0"></i> Niveau 4<br>';
            div.innerHTML += '<i style="background: #ff9800"></i> Niveau 3<br>';
            div.innerHTML += '<i style="background: #4caf50"></i> Niveau 2<br>';
            
            div.innerHTML += "<h4 style='margin-top:8px'>Interieur & Advies</h4>";
            div.innerHTML += '<i style="background: #e91e63"></i> Niveau 4<br>';
            div.innerHTML += '<i style="background: #fdd835"></i> Niveau 3<br>';
            div.innerHTML += '<i style="background: #00bcd4"></i> Niveau 2<br>';
            
            div.innerHTML += "<h4 style='margin-top:8px; color:#f44336'>Status</h4>";
            div.innerHTML += '<i style="background: #f44336"></i> VOL / Vraag docent<br>';
            return div;
        };
        legend.addTo(map);

        // --- ROUTE FUNCTIE (OV DEFAULT) ---
        window.startRoute = function(lat, lng, inputId) {
            var inputVeld = document.getElementById(inputId);
            var vertrekPunt = inputVeld.value; 
            var baseUrl = "https://www.google.com/maps/dir/?api=1";
            var destination = `&destination=${lat},${lng}`;
            var mode = "&travelmode=transit"; // OV
            
            var finalUrl = vertrekPunt && vertrekPunt.trim() !== "" 
                ? `${baseUrl}&origin=${encodeURIComponent(vertrekPunt)}${destination}${mode}`
                : `${baseUrl}${destination}${mode}`;
            
            window.open(finalUrl, '_blank');
        };

        // --- DATA LADEN ---
        function laadPunten() {
            Papa.parse(googleSheetCSV, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    var data = results.data;
                    console.log("Rijen geladen:", data.length); 

                    data.forEach(function(rij) {
                        if(rij['LAT LONG'] && rij['LAT LONG'].includes(',')) {
                            
                            var parts = rij['LAT LONG'].split(',');
                            var lat = parseFloat(parts[0]);
                            var lng = parseFloat(parts[1]);
                            var uniekId = rij.Id ? rij.Id : Math.floor(Math.random() * 1000000);

                            if (!isNaN(lat) && !isNaN(lng)) {

                                // DATA UITLEZEN
                                var status = rij.STATUS ? rij.STATUS.toLowerCase().trim() : '';
                                var capaciteit = rij.Capaciteit ? rij.Capaciteit : '?';

                                // Linkjes
                                var streetViewLink = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
                                var url = rij.Website ? rij.Website.trim() : '';
                                if (url.length > 0 && !url.toLowerCase().startsWith('http')) url = 'http://' + url;
                                var websiteLink = url ? `<a href="${url}" target="_blank" class="website-link">üåê Website bezoeken</a>` : '';

                                // MARKER FABRIEK
                                function maakMarker(kleur, niveauLabel, layerGroup) {
                                    var finalColor = kleur;
                                    var label = niveauLabel;
                                    
                                    // Status check: Als V, dan rood
                                    if (status === 'v') {
                                        finalColor = '#f44336';
                                        label = "VOL / Vraag docent";
                                    }

                                    var marker = L.circleMarker([lat, lng], {
                                        radius: 8,
                                        fillColor: finalColor,
                                        color: "white", weight: 2, opacity: 1, fillOpacity: 0.9
                                    });

                                    var popupHTML = `
                                        <div class="popup-content">
                                            <div class="popup-header">${rij.Naam}</div>
                                            <span class="popup-cap">Capaciteit: ${capaciteit}</span>
                                            <span class="popup-level" style="background:${finalColor}">${label}</span>
                                            <p>${rij.Adres}<br>${rij.Postcode} ${rij.Plaatsnaam}</p>
                                            
                                            <a href="${streetViewLink}" target="_blank" class="btn-action btn-streetview">üëÄ Streetview</a>
                                            ${websiteLink}

                                            <div class="route-box">
                                                <small>Plan OV-route vanaf:</small><br>
                                                <input type="text" id="route-${uniekId}-${label.replace(/\s/g,'')}" class="route-input" placeholder="Postcode of station...">
                                                <button onclick="startRoute('${lat}', '${lng}', 'route-${uniekId}-${label.replace(/\s/g,'')}')" class="btn-go">Go</button>
                                            </div>
                                        </div>
                                    `;
                                    marker.bindPopup(popupHTML);
                                    layerGroup.addLayer(marker);
                                }

                                // CHECK & PLAATS MARKERS (HM)
                                if (rij['HM_N2']) maakMarker('#4caf50', 'HM Niveau 2', cl_HM_N2); 
                                if (rij['HM_N3']) maakMarker('#ff9800', 'HM Niveau 3', cl_HM_N3); 
                                if (rij['HM_N4']) maakMarker('#9c27b0', 'HM Niveau 4', cl_HM_N4); 

                                // CHECK & PLAATS MARKERS (IA)
                                if (rij['IA_N2']) maakMarker('#00bcd4', 'IA Niveau 2', cl_IA_N2); 
                                if (rij['IA_N3']) maakMarker('#fdd835', 'IA Niveau 3', cl_IA_N3); 
                                if (rij['IA_N4']) maakMarker('#e91e63', 'IA Niveau 4', cl_IA_N4); 
                            }
                        }
                    });
                }
            });
        }

        laadPunten();

// --- MENU OPMAAK FIX (Veilige Versie) ---
        // Voegt headers toe, maar checkt eerst of ze er niet al staan.
        setTimeout(function() {
            var labels = document.querySelectorAll('.leaflet-control-layers-overlays label span');
            
            labels.forEach(function(span) {
                var tekst = span.innerHTML;
                var labelRij = span.parentElement; // Het <label> element
                
                // VEILIGHEIDSCHECK: Hebben we hier al een kopje gezet?
                if (labelRij.classList.contains('header-placed')) return;

                // Zoek Hout & Meubel
                if (tekst.includes('HM Niveau 2')) {
                    var header = document.createElement('div');
                    header.className = 'menu-header';
                    header.innerHTML = 'üìÇ Hout & Meubel';
                    
                    // Plaats header en zet de stempel
                    labelRij.parentElement.insertBefore(header, labelRij);
                    labelRij.classList.add('header-placed'); 
                }
                
                // Zoek Interieur & Advies
                if (tekst.includes('IA Niveau 2')) {
                    var header = document.createElement('div');
                    header.className = 'menu-header';
                    header.innerHTML = 'üìÇ Interieur & Advies';
                    
                    // Plaats header en zet de stempel
                    labelRij.parentElement.insertBefore(header, labelRij);
                    labelRij.classList.add('header-placed');
                }
            });
        }, 100);

    </script>
</body>
</html>


